---
// src/components/MobileMenu.astro
import { SITE_MENU } from "../config/constants";
import Login from "./icons/Login.astro";
---

<!-- Botón Hamburguesa (solo visible en móvil) -->
<button
    id="mobile-menu-button"
    class="xl:hidden text-white focus:outline-none mr-5"
    aria-label="Menú principal"
>
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
</button>

<!-- Menú Mobile (oculto por defecto) -->
<div
    id="mobile-menu"
    class="2xl:hidden fixed inset-0 bg-primary z-50 transition-all duration-300 ease-in-out opacity-0 invisible overflow-y-scroll"
    style="display: none;"
>
    <div class="container mx-auto px-4 py-8 h-full flex flex-col">
        <!-- Botón de cerrar -->
        <div class="flex justify-end mb-8">
            <button
                id="close-menu-button"
                class="text-white p-2 focus:outline-none"
                aria-label="Cerrar menú"
            >
                <svg
                    class="w-8 h-8"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Botón de Acceder -->
        <!-- <div class="mb-8">
            <a
                href={import.meta.env.DASHBOARD_URL}
                class="inline-flex w-full py-4 items-center text-white border border-white rounded-md px-4 gap-x-3 hover:bg-white hover:text-primary transition-colors text-2xl"
            >
                <Login classname="size-9" />
                <span>Acceder</span>
            </a>
        </div> -->

        <!-- Lista de menú -->
        <ul class="space-y-6">
            {
                SITE_MENU.map((item, index) => (
                    <li class="border-b border-white/20 pb-4">
                        <div class="flex items-center justify-between">
                            {item.submenu ? (
                                <>
                                    <button
                                        class="text-white text-2xl font-medium py-2 hover:text-blue-300 transition-colors flex-grow text-left submenu-main-button"
                                        data-submenu-index={index}
                                    >
                                        {item.text}
                                    </button>
                                    <button
                                        class="submenu-toggle text-white p-2 focus:outline-none"
                                        aria-label="Abrir submenú"
                                        data-submenu-index={index}
                                    >
                                        <svg
                                            class="w-6 h-6 transform transition-transform duration-300"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 9l-7 7-7-7"
                                            />
                                        </svg>
                                    </button>
                                </>
                            ) : (
                                <a
                                    href={item.link}
                                    class="text-white text-2xl font-medium py-2 hover:text-blue-300 transition-colors menu-link w-full"
                                >
                                    {item.text}
                                </a>
                            )}
                        </div>

                        {item.submenu && (
                            <ul
                                class="ml-4 mt-2 space-y-2 submenu hidden"
                                data-submenu={index}
                            >
                                {item.submenu.map((subitem) => (
                                    <li>
                                        <a
                                            href={subitem.link}
                                            class="block text-white/80 py-1 hover:text-blue-300 transition-colors submenu-link"
                                        >
                                            {subitem.text}
                                        </a>
                                    </li>
                                ))}
                            </ul>
                        )}
                    </li>
                ))
            }
        </ul>
    </div>
</div>

<!-- Cargamos el script solo en el cliente -->
<script is:inline>
    // Verificamos si estamos en el navegador
    if (typeof window !== "undefined") {
        function initMobileMenu() {
            const menuButton = document.getElementById("mobile-menu-button");
            const closeButton = document.getElementById("close-menu-button");
            const mobileMenu = document.getElementById("mobile-menu");

            if (!menuButton || !closeButton || !mobileMenu) {
                console.error("No se encontraron elementos del menú móvil");
                return;
            }

            // Mostrar el menú móvil (en el cliente)
            mobileMenu.style.display = "block";

            const openMenu = () => {
                mobileMenu.classList.remove("opacity-0");
                mobileMenu.classList.remove("invisible");
                mobileMenu.classList.add("opacity-100");
            };

            const closeMenu = () => {
                mobileMenu.classList.add("opacity-0");
                mobileMenu.classList.add("invisible");
                mobileMenu.classList.remove("opacity-100");
            };

            const toggleSubmenu = (e, index) => {
                // Solo procesar si es el click principal (evitar eventos duplicados)
                if (e.eventPhase !== Event.AT_TARGET) return;

                e.preventDefault();
                e.stopImmediatePropagation(); // Usamos stopImmediatePropagation en lugar de stopPropagation

                const submenu = document.querySelector(
                    `[data-submenu="${index}"]`,
                );
                if (!submenu) {
                    console.error(`Submenu no encontrado para índice ${index}`);
                    return;
                }

                // Determinar el elemento que realmente disparó el evento
                const actualTarget = e.target.closest("[data-submenu-index]");
                if (!actualTarget) return;

                // Encontrar la flecha correcta
                const arrow = actualTarget.querySelector("svg");

                // Usar classList.replace para un toggle más seguro
                const wasHidden = submenu.classList.contains("hidden");

                if (wasHidden) {
                    submenu.classList.remove("hidden");
                    if (arrow) arrow.classList.add("rotate-180");
                } else {
                    submenu.classList.add("hidden");
                    if (arrow) arrow.classList.remove("rotate-180");
                }

                // Agregar timeout para prevenir doble toggle
                actualTarget.style.pointerEvents = "none";
                setTimeout(() => {
                    actualTarget.style.pointerEvents = "auto";
                }, 300);
            };
            // Event listeners
            menuButton.addEventListener("click", openMenu);
            closeButton.addEventListener("click", closeMenu);

            document
                .querySelectorAll(".submenu-toggle, .submenu-main-button")
                .forEach((button) => {
                    const index = button.getAttribute("data-submenu-index");
                    if (index) {
                        button.addEventListener("click", (e) =>
                            toggleSubmenu(e, index),
                        );
                    }
                });

            document
                .querySelectorAll(".menu-link, .submenu-link")
                .forEach((link) => {
                    link.addEventListener("click", closeMenu);
                });
        }

        // Inicialización
        if (
            document.readyState === "complete" ||
            document.readyState === "interactive"
        ) {
            initMobileMenu();
        } else {
            document.addEventListener("DOMContentLoaded", initMobileMenu);
        }

        // Manejo de navegación en Astro
        document.addEventListener("astro:page-load", initMobileMenu);
        document.addEventListener("astro:after-swap", initMobileMenu);
    }
</script>

<style is:global>
    .rotate-180 {
        transform: rotate(180deg);
    }

    .submenu {
        transition: all 0.3s ease;
        max-height: 0;
        overflow: hidden;
    }

    .submenu:not(.hidden) {
        max-height: 500px;
    }
</style>
