---
// src/components/Navbar.astro
import { SITE_MENU } from "../config/constants";
import MobileMenu from "./MobileMenu.astro";

interface Props {
    classname?: string;
    text?: boolean;
}

const { classname, text = false } = Astro.props;
---

<nav class={`${classname} w-full z-40 py-2 bg-primary relative`}>
    <div class="px-5 mx-auto flex justify-between items-center relative">
        <div class="flex items-center gap-x-5">
            <img src="/images/logo.png" alt="Logo" class="w-16 md:w-24 h-fit" />
            <div class="text-white space-y-2">
                <p class="text-lg md:text-2xl uppercase">Palacio de Justicia</p>
                <div class="w-full h-[0.1px] bg-white/60"></div>
                <p>Guinea Ecuatorial</p>
            </div>
        </div>

        <!-- Menú Desktop (oculto en mobile) -->
        <ul class="hidden xl:flex justify-center items-center text-white">
            {
                SITE_MENU.map((item) => (
                    <li
                        class="relative"
                        id={`menu-item-${item.text.toLowerCase().replace(/\s+/g, "-")}`}
                    >
                        <a
                            href={item.link}
                            class="px-4 py-2 hover:bg-white/20 rounded transition-colors flex items-center menu-item"
                            onclick={
                                item.submenu
                                    ? "event.preventDefault();toggleSlideMenu(this)"
                                    : ""
                            }
                        >
                            {item.text}
                            {item.submenu && (
                                <svg
                                    class="w-4 h-4 ml-1 transition-transform duration-200"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M19 9l-7 7-7-7"
                                    />
                                </svg>
                            )}
                        </a>
                    </li>
                ))
            }
        </ul>

        <!-- Componente MobileMenu -->
        <MobileMenu />
    </div>

    <!-- Contenedor para submenús - justo debajo del nav principal -->
    <div class="submenu-container absolute w-full left-0">
        {
            SITE_MENU.map(
                (item) =>
                    item.submenu && (
                        <div
                            id={`submenu-${item.text.toLowerCase().replace(/\s+/g, "-")}`}
                            class="hidden w-full bg-white shadow-lg overflow-hidden transition-all duration-300 ease-in-out origin-top"
                            style="height: 0; opacity: 0;"
                        >
                            <div class="max-w-7xl mx-auto px-4 py-4 grid grid-cols-4 gap-6">
                                {item.submenu.map((subitem) => (
                                    <a
                                        href={subitem.link}
                                        class="block px-4 py-3 hover:bg-gray-100 rounded transition-colors text-gray-800 hover:text-primary"
                                    >
                                        <h3 class="font-bold text-lg mb-1">
                                            {subitem.text}
                                        </h3>
                                        <p class="text-sm text-gray-600">
                                            Descripción del servicio...
                                        </p>
                                    </a>
                                ))}
                            </div>
                        </div>
                    ),
            )
        }
    </div>
</nav>

<script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
        // Variable para llevar el seguimiento del menú abierto
        let currentOpenMenu = null;

        // Función para mostrar/ocultar menús deslizantes
        window.toggleSlideMenu = (element) => {
            const parentLi = element.closest("li");
            const menuId = parentLi.id.replace("menu-item-", "submenu-");
            const submenu = document.getElementById(menuId);
            const arrow = parentLi.querySelector("svg");

            // Si hay un menú abierto y es diferente al actual, lo cerramos
            if (currentOpenMenu && currentOpenMenu !== submenu) {
                closeMenu(currentOpenMenu);
            }

            // Alternar el menú actual
            if (submenu.classList.contains("hidden")) {
                openMenu(submenu, arrow);
                currentOpenMenu = submenu;
            } else {
                closeMenu(submenu, arrow);
                currentOpenMenu = null;
            }
        };

        // Función para abrir menú con animación
        function openMenu(menu, arrow) {
            menu.classList.remove("hidden");
            // Forzar reflow para que la animación funcione
            void menu.offsetHeight;
            menu.style.height = "auto";
            const height = menu.scrollHeight;
            menu.style.height = "0";

            setTimeout(() => {
                menu.style.height = `${height}px`;
                menu.style.opacity = "1";
                if (arrow) arrow.classList.add("rotate-180");
            }, 10);
        }

        // Función para cerrar menú con animación
        function closeMenu(menu, arrow) {
            menu.style.height = `${menu.scrollHeight}px`;

            // Forzar reflow
            void menu.offsetHeight;

            menu.style.height = "0";
            menu.style.opacity = "0";
            if (arrow) arrow.classList.remove("rotate-180");

            // Esperar a que termine la animación para ocultar
            setTimeout(() => {
                menu.classList.add("hidden");
            }, 300);
        }

        // Cerrar menú al hacer click fuera
        document.addEventListener("click", (e) => {
            if (
                !e.target.closest(".menu-item") &&
                !e.target.closest('[id^="submenu-"')
            ) {
                if (currentOpenMenu) {
                    const arrow = document.querySelector(
                        `#${currentOpenMenu.id.replace("submenu-", "menu-item-")} svg`,
                    );
                    closeMenu(currentOpenMenu, arrow);
                    currentOpenMenu = null;
                }
            }
        });
    });
</script>

<style is:global>
    /* Rotación de flecha */
    .rotate-180 {
        transform: rotate(180deg);
    }

    /* Transición suave para el submenú */
    [id^="submenu-"] {
        will-change: height, opacity;
        box-shadow:
            0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -1px rgba(0, 0, 0, 0.06);
        z-index: 30;
        transition:
            height 0.3s ease-in-out,
            opacity 0.3s ease-in-out;
    }

    /* Aseguramos que el submenu-container esté justo debajo del nav */
    .submenu-container {
        top: 100%;
        z-index: 20;
    }
</style>
