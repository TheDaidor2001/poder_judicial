---
import Navbar from "../components/Navbar.astro";
import MainLayout from "../layouts/MainLayout.astro";
---

<MainLayout title="Poder Judicial de Guinea Ecuatorial | Contacto">
    <section class="max-w-7xl mx-auto px-5 xl:px-0 py-20">
        <!-- Hero Section -->
        <div class="relative bg-primary/10 rounded-xl overflow-hidden mb-16">
            <div class="relative z-10 py-20 px-8 md:px-16">
                <h1 class="text-4xl md:text-5xl font-bold text-primary mb-4">
                    Contacte con el Palacio de Justicia
                </h1>
                <p class="text-xl text-gray-600 max-w-2xl">
                    Estamos a su disposición para atender sus consultas y
                    solicitudes relacionadas con la administración de justicia.
                </p>
            </div>
        </div>

        <!-- Grid de Contacto -->
        <div class="grid md:grid-cols-2 gap-12">
            <!-- Formulario -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">
                    Formulario de contacto
                </h2>

                <form
                    id="contactForm"
                    class="space-y-6"
                    enctype="multipart/form-data"
                >
                    <!-- Nombre completo -->
                    <div>
                        <label
                            for="nombre"
                            class="block text-gray-700 mb-2 font-medium"
                            >Nombre completo <span class="text-red-500">*</span
                            ></label
                        >
                        <input
                            type="text"
                            id="nombre"
                            name="nombre"
                            required
                            minlength="3"
                            maxlength="100"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
                            placeholder="Ingrese su nombre completo"
                        />
                        <span
                            class="error-message text-red-500 text-sm mt-1 hidden"
                            >Este campo es obligatorio (mínimo 3 caracteres)</span
                        >
                    </div>

                    <!-- Número de DIP -->
                    <div>
                        <label
                            for="dip"
                            class="block text-gray-700 mb-2 font-medium"
                            >Nº de DIP (Documento de Identificación Personal) <span
                                class="text-red-500">*</span
                            ></label
                        >
                        <input
                            type="text"
                            id="dip"
                            name="dip"
                            required
                            pattern="[0-9]{3}\.[0-9]{3}\.[0-9]{3}"
                            placeholder="000.000.000"
                            maxlength="11"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
                        />
                        <span
                            class="error-message text-red-500 text-sm mt-1 hidden"
                            >Formato requerido: 000.000.000</span
                        >
                        <p class="text-gray-500 text-xs mt-1">
                            Formato: 000.000.000
                        </p>
                    </div>

                    <!-- Número de teléfono -->
                    <div>
                        <label
                            for="telefono"
                            class="block text-gray-700 mb-2 font-medium"
                            >Nº de Teléfono <span class="text-red-500">*</span
                            ></label
                        >
                        <input
                            type="tel"
                            id="telefono"
                            name="telefono"
                            required
                            placeholder="+240 222 123 456 o 222123456"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
                        />
                        <span
                            class="error-message text-red-500 text-sm mt-1 hidden"
                            >Ingrese un número válido (+240XXXXXXXXX o
                            XXXXXXXXX)</span
                        >
                        <p class="text-gray-500 text-xs mt-1">
                            Ejemplo: +240 222 123 456
                        </p>
                    </div>

                    <!-- Correo electrónico -->
                    <div>
                        <label
                            for="email"
                            class="block text-gray-700 mb-2 font-medium"
                            >Correo electrónico <span class="text-red-500"
                                >*</span
                            ></label
                        >
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
                            placeholder="ejemplo@correo.com"
                        />
                        <span
                            class="error-message text-red-500 text-sm mt-1 hidden"
                            >Ingrese un email válido</span
                        >
                    </div>

                    <!-- Asunto -->
                    <div>
                        <label
                            for="asunto"
                            class="block text-gray-700 mb-2 font-medium"
                            >Selecciona el Asunto <span class="text-red-500"
                                >*</span
                            ></label
                        >
                        <select
                            id="asunto"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
                            name="asunto"
                            required
                        >
                            <option value="">Selecciona un asunto</option>
                            <option value="Consulta general"
                                >Consulta general</option
                            >
                            <option
                                value="Información sobre procesos judiciales"
                                >Información sobre procesos judiciales</option
                            >
                            <option value="Solicitud de documentación"
                                >Solicitud de documentación</option
                            >
                            <option value="Denuncia o queja"
                                >Denuncia o queja</option
                            >
                            <option value="Certificados y copias"
                                >Certificados y copias</option
                            >
                            <option value="Recursos y apelaciones"
                                >Recursos y apelaciones</option
                            >
                            <option value="Otros">Otros</option>
                        </select>
                        <span
                            class="error-message text-red-500 text-sm mt-1 hidden"
                            >Seleccione un asunto</span
                        >
                    </div>

                    <!-- Adjuntar documento -->
                    <div>
                        <label
                            for="archivo"
                            class="block text-gray-700 mb-2 font-medium"
                            >Adjuntar documento (opcional)</label
                        >
                        <div class="relative">
                            <input
                                type="file"
                                id="archivo"
                                name="archivo"
                                accept=".pdf,.doc,.docx"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary-dark"
                            />
                        </div>
                        <span
                            class="error-message text-red-500 text-sm mt-1 hidden"
                            >Solo se permiten archivos PDF, DOC o DOCX (máximo
                            10MB)</span
                        >
                        <p class="text-gray-500 text-xs mt-1">
                            Archivos permitidos: PDF, DOC, DOCX. Tamaño máximo:
                            10MB
                        </p>
                    </div>

                    <!-- Mensaje -->
                    <div>
                        <label
                            for="mensaje"
                            class="block text-gray-700 mb-2 font-medium"
                            >Mensaje <span class="text-red-500">*</span></label
                        >
                        <textarea
                            id="mensaje"
                            rows="6"
                            required
                            minlength="10"
                            maxlength="1000"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors resize-vertical"
                            name="mensaje"
                            placeholder="Escriba su mensaje aquí (mínimo 10 caracteres)..."
                        ></textarea>
                        <span
                            class="error-message text-red-500 text-sm mt-1 hidden"
                            >El mensaje debe tener entre 10 y 1000 caracteres</span
                        >
                        <div
                            class="flex justify-between text-xs text-gray-500 mt-1"
                        >
                            <span>Mínimo 10 caracteres</span>
                            <span id="charCount">0/1000</span>
                        </div>
                    </div>

                    <button
                        type="submit"
                        class="w-full bg-secondary hover:bg-primary-dark text-white font-medium py-3 px-6 rounded-lg transition duration-300 cursor-pointer hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Enviar mensaje
                    </button>
                </form>
            </div>

            <!-- Información de Contacto -->
           
        </div>

        <!-- Mapa -->
        <div class="mt-16 bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Ubicación</h2>
                <div
                    class="aspect-w-16 aspect-h-9 bg-gray-200 rounded-lg overflow-hidden"
                >
                    <!-- Iframe de Google Maps o similar -->
                    <iframe
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3981.3617509916353!2d8.757800374470918!3d3.7310830493009046!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x10669e65419a6f63%3A0xe89ae16f785f08fb!2sPalacio%20De%20Justicia!5e0!3m2!1sen!2sus!4v1748094659451!5m2!1sen!2sus"
                        width="100%"
                        height="450"
                        style="border:0;"
                        allowfullscreen=""
                        loading="lazy"
                        class="w-full h-[450px]"></iframe>
                </div>
            </div>
        </div>

        <!-- Modal de Alerta Personalizada -->
        <div
            id="customAlert"
            class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center p-4 opacity-0 invisible transition-all duration-300"
        >
            <div
                id="alertBox"
                class="bg-white rounded-xl shadow-2xl max-w-md w-full transform scale-95 transition-transform duration-300"
            >
                <!-- Header con ícono -->
                <div id="alertHeader" class="p-6 pb-4">
                    <!-- Ícono de éxito -->
                    <div
                        id="successIcon"
                        class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 hidden"
                    >
                        <svg
                            class="h-8 w-8 text-green-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <!-- Ícono de error -->
                    <div
                        id="errorIcon"
                        class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 hidden"
                    >
                        <svg
                            class="h-8 w-8 text-red-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </div>
                </div>

                <!-- Contenido -->
                <div class="px-6 pb-4 text-center">
                    <h3
                        id="alertTitle"
                        class="text-xl font-semibold text-gray-900 mb-2"
                    >
                    </h3>
                    <p id="alertMessage" class="text-gray-600"></p>
                </div>

                <!-- Botón -->
                <div class="px-6 pb-6">
                    <button
                        id="alertButton"
                        class="w-full bg-secondary hover:bg-primary text-white font-medium py-3 px-4 rounded-lg transition duration-300"
                        onclick="closeCustomAlert()"
                    >
                        Aceptar
                    </button>
                </div>
            </div>
        </div>
    </section>
</MainLayout>

<style>
    .field-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }

    .field-success {
        border-color: #10b981 !important;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
    }

    /* Animaciones para la alerta */
    #customAlert.show {
        opacity: 1;
        visibility: visible;
    }

    #customAlert.show #alertBox {
        transform: scale(1);
    }
</style>

<script is:inline>
    // Funciones para mostrar/ocultar alerta personalizada
    function showCustomAlert(type, title, message) {
        const alertElement = document.getElementById("customAlert");
        const alertBox = document.getElementById("alertBox");
        const successIcon = document.getElementById("successIcon");
        const errorIcon = document.getElementById("errorIcon");
        const alertTitle = document.getElementById("alertTitle");
        const alertMessage = document.getElementById("alertMessage");
        const alertButton = document.getElementById("alertButton");

        // Configurar el tipo de alerta
        if (type === "success") {
            successIcon.classList.remove("hidden");
            errorIcon.classList.add("hidden");
            alertButton.classList.remove("bg-red-600", "hover:bg-red-700");
            alertButton.classList.add("bg-secondary", "hover:bg-primary");
        } else {
            errorIcon.classList.remove("hidden");
            successIcon.classList.add("hidden");
            alertButton.classList.remove("bg-secondary", "hover:bg-primary");
            alertButton.classList.add("bg-red-600", "hover:bg-red-700");
        }

        // Configurar el contenido
        alertTitle.textContent = title;
        alertMessage.textContent = message;

        // Mostrar la alerta
        alertElement.classList.add("show");
        document.body.style.overflow = "hidden";
    }

    function closeCustomAlert() {
        const alertElement = document.getElementById("customAlert");
        alertElement.classList.remove("show");
        document.body.style.overflow = "";
    }

    // Cerrar alerta con tecla Escape
    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
            closeCustomAlert();
        }
    });

    // Cerrar alerta al hacer clic fuera
    document
        .getElementById("customAlert")
        .addEventListener("click", function (e) {
            if (e.target === this) {
                closeCustomAlert();
            }
        });

    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("contactForm");
        const charCountElement = document.getElementById("charCount");
        const mensajeTextarea = document.getElementById("mensaje");

        if (!form) {
            console.error("Formulario no encontrado");
            return;
        }

        // Contador de caracteres para el mensaje
        if (mensajeTextarea && charCountElement) {
            mensajeTextarea.addEventListener("input", function () {
                const count = this.value.length;
                charCountElement.textContent = `${count}/1000`;

                if (count > 1000) {
                    charCountElement.classList.add("text-red-500");
                } else {
                    charCountElement.classList.remove("text-red-500");
                }
            });
        }

        // Formateo automático del DIP
        const dipInput = document.getElementById("dip");
        if (dipInput) {
            dipInput.addEventListener("input", function (e) {
                let value = e.target.value.replace(/\D/g, ""); // Solo números
                if (value.length >= 3) {
                    value = value.substring(0, 3) + "." + value.substring(3);
                }
                if (value.length >= 7) {
                    value =
                        value.substring(0, 7) + "." + value.substring(7, 10);
                }
                e.target.value = value;
            });
        }

        // Formateo del número de teléfono
        const telefonoInput = document.getElementById("telefono");
        if (telefonoInput) {
            telefonoInput.addEventListener("input", function (e) {
                let value = e.target.value.replace(/\D/g, "");

                // Si empieza por 240, añadir el +
                if (value.startsWith("240")) {
                    value = "+" + value;
                }

                e.target.value = value;
            });
        }

        // Función para validar email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Función para validar DIP
        function isValidDIP(dip) {
            const dipRegex = /^[0-9]{3}\.[0-9]{3}\.[0-9]{3}$/;
            return dipRegex.test(dip);
        }

        // Función para validar teléfono
        function isValidPhone(phone) {
            const phoneRegex = /^(\+240[0-9]{9}|[0-9]{9})$/;
            return phoneRegex.test(phone.replace(/\s/g, ""));
        }

        // Función para validar archivo (actualizada para soportar DOC y DOCX)
        function isValidFile(file) {
            if (!file) return true; // Opcional

            const validTypes = [
                "application/pdf",
                "application/msword", // DOC
                "application/vnd.openxmlformats-officedocument.wordprocessingml.document", // DOCX
            ];
            const maxSize = 10 * 1024 * 1024; // 10MB

            return validTypes.includes(file.type) && file.size <= maxSize;
        }

        // Función para mostrar/ocultar errores
        function toggleError(element, show, message = "") {
            const errorSpan = element.nextElementSibling;
            if (errorSpan && errorSpan.classList.contains("error-message")) {
                errorSpan.textContent = message;
                errorSpan.classList.toggle("hidden", !show);
                element.classList.toggle("field-error", show);
                element.classList.toggle(
                    "field-success",
                    !show && element.value.trim(),
                );
            }
        }

        // Validación en tiempo real
        form.querySelectorAll("input, select, textarea").forEach((input) => {
            input.addEventListener("blur", function () {
                validateField(this);
            });

            // Validación especial para el archivo
            if (input.type === "file") {
                input.addEventListener("change", function () {
                    validateField(this);
                });
            }
        });

        // Función de validación de campos
        function validateField(field) {
            let isValid = true;
            let message = "";

            // Validaciones específicas por campo
            switch (field.id) {
                case "nombre":
                    if (!field.value.trim()) {
                        isValid = false;
                        message = "Este campo es obligatorio";
                    } else if (field.value.trim().length < 3) {
                        isValid = false;
                        message = "El nombre debe tener al menos 3 caracteres";
                    }
                    break;

                case "dip":
                    if (!field.value.trim()) {
                        isValid = false;
                        message = "Este campo es obligatorio";
                    } else if (field.value.trim().length < 5) {
                        isValid = false;
                        message = "El DIP debe tener al menos 5 caracteres";
                    } else if (!isValidDIP(field.value)) {
                        isValid = false;
                        message = "Formato requerido: 000.000.000";
                    }
                    break;

                case "telefono":
                    if (!field.value.trim()) {
                        isValid = false;
                        message = "Este campo es obligatorio";
                    } else if (field.value.trim().length < 8) {
                        isValid = false;
                        message =
                            "El teléfono debe tener al menos 8 caracteres";
                    } else if (!isValidPhone(field.value)) {
                        isValid = false;
                        message = "Número de teléfono inválido";
                    }
                    break;

                case "email":
                    if (!field.value.trim()) {
                        isValid = false;
                        message = "Este campo es obligatorio";
                    } else if (!isValidEmail(field.value)) {
                        isValid = false;
                        message = "Ingrese un email válido";
                    }
                    break;

                case "asunto":
                    if (!field.value) {
                        isValid = false;
                        message = "Seleccione un asunto";
                    } else if (field.value.length < 5) {
                        isValid = false;
                        message = "El asunto debe tener al menos 5 caracteres";
                    }
                    break;

                case "archivo":
                    if (field.files && field.files[0]) {
                        if (!isValidFile(field.files[0])) {
                            isValid = false;
                            message =
                                "Solo se permiten archivos PDF, DOC o DOCX (máximo 10MB)";
                        }
                    }
                    break;

                case "mensaje":
                    if (!field.value.trim()) {
                        isValid = false;
                        message = "Este campo es obligatorio";
                    } else if (field.value.trim().length < 10) {
                        isValid = false;
                        message =
                            "El mensaje debe tener al menos 10 caracteres";
                    } else if (field.value.length > 1000) {
                        isValid = false;
                        message = "El mensaje no puede exceder 1000 caracteres";
                    }
                    break;

                default:
                    if (field.required && !field.value.trim()) {
                        isValid = false;
                        message = "Este campo es obligatorio";
                    }
                    break;
            }

            toggleError(field, !isValid, message);
            return isValid;
        }

        // Manejo del envío
        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            // Validación final antes de enviar
            let isValid = true;
            form.querySelectorAll("input, select, textarea").forEach(
                (field) => {
                    if (!validateField(field)) {
                        isValid = false;
                    }
                },
            );

            if (!isValid) {
                showCustomAlert(
                    "error",
                    "Error en el formulario",
                    "Por favor, corrija los errores en el formulario antes de enviarlo.",
                );
                return;
            }

            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = "Enviando...";

            try {
                const formData = new FormData(form);
                const response = await fetch("/api/sendEmail.json", {
                    method: "POST",
                    body: formData,
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Usar el mensaje de la respuesta de la API
                    const successMessage =
                        result.data && result.data.message
                            ? result.data.message
                            : result.message ||
                              "Mensaje enviado con éxito. Nos pondremos en contacto con usted pronto.";

                    showCustomAlert(
                        "success",
                        "Mensaje enviado",
                        successMessage,
                    );

                    form.reset();

                    // Reset contador de caracteres
                    if (charCountElement) {
                        charCountElement.textContent = "0/1000";
                        charCountElement.classList.remove("text-red-500");
                    }

                    // Limpiar validaciones visuales
                    form.querySelectorAll(
                        ".field-error, .field-success",
                    ).forEach((field) => {
                        field.classList.remove("field-error", "field-success");
                    });
                } else {
                    throw new Error(
                        result.message || "Error al enviar el formulario",
                    );
                }
            } catch (error) {
                console.error("Error:", error);
                showCustomAlert(
                    "error",
                    "Error al enviar",
                    error.message ||
                        "Hubo un error al enviar el formulario. Por favor, inténtelo de nuevo.",
                );
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });
    });
</script>
