---
import Navbar from "../components/Navbar.astro";
import CardNoticia from "../components/noticias/CardNoticia.astro";
import NewsLayout from "../layouts/NewsLayout.astro";
import { fetchNewsPaginated, formatPublishedDate } from "../utils/newsAPI";

// Obtener página actual de los query params
const currentPage = Number(Astro.url.searchParams.get('page')) || 1;

// Fetch noticias de la página actual
let news: any[] = [];
let hasMore = false;
let totalPages: number | undefined = undefined;
let error: string | null = null;

try {
  const result = await fetchNewsPaginated(currentPage);
  news = result.news;
  hasMore = result.hasMore;
  totalPages = result.totalPages;
} catch (e) {
  error = e instanceof Error ? e.message : 'Error desconocido al cargar noticias';
  console.error('Error fetching news:', e);
}

// Generar array de páginas a mostrar
const getPagesToShow = () => {
  const pages = [];

  // Si conocemos el total de páginas, generar todas las visibles
  if (totalPages !== undefined) {
    // Mostrar todas si son pocas páginas (≤5)
    if (totalPages <= 5) {
      for (let i = 1; i <= totalPages; i++) {
        pages.push(i);
      }
    } else {
      // Para muchas páginas, mostrar solo las cercanas
      for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        pages.push(i);
      }
    }
  } else {
    // Si no conocemos el total, generar basado en hasMore
    for (let i = Math.max(1, currentPage - 2); i < currentPage; i++) {
      pages.push(i);
    }
    pages.push(currentPage);

    if (hasMore) {
      for (let i = currentPage + 1; i <= currentPage + 2; i++) {
        pages.push(i);
      }
    }
  }

  return pages;
};

const pagesToShow = getPagesToShow();
const showFirstPage = totalPages !== undefined && currentPage > 3 && totalPages > 5;
const showLastPage = totalPages !== undefined && currentPage < totalPages - 2 && totalPages > 5;

// Determinar si hay página siguiente
const hasNextPage = totalPages !== undefined ? currentPage < totalPages : hasMore;
const hasPrevPage = currentPage > 1;
---

<NewsLayout title="Palacio de Justicia de Guinea Ecuatorial | Historia">
    <section class="w-full xl:col-span-3 flex flex-col min-h-[70vh]">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-primary mb-3">
                Noticias Judiciales
            </h1>
            <p class="text-gray-600 text-lg">
                Las últimas noticias relacionadas con el palacio de justicia
            </p>
            <div class="w-20 h-1 bg-secondary mt-4"></div>
        </div>

        <!-- Error State -->
        {error && (
            <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg shadow-sm">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-semibold text-red-800">Error al cargar noticias</h3>
                        <p class="text-red-700 mt-1">{error}</p>
                    </div>
                </div>
            </div>
        )}

        <!-- Empty State -->
        {!error && news.length === 0 && (
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded-lg shadow-sm">
                <div class="flex items-center">
                    <svg class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="ml-3 text-yellow-800 font-medium">No hay noticias disponibles en esta página.</p>
                </div>
            </div>
        )}

        <!-- News Grid - Ocupa el espacio restante -->
        {!error && news.length > 0 && (
            <div class="flex-1 flex flex-col">
                <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden flex-1">
                    <div class="divide-y divide-gray-200">
                        {news.map((noticia) => (
                            <CardNoticia
                                date={formatPublishedDate(noticia.publishedAt)}
                                title={noticia.title}
                                description={noticia.subtitle}
                                url={`/noticias/${noticia.slug}`}
                                image={noticia.imageUrl}
                            />
                        ))}
                    </div>
                </div>

                <!-- Pagination -->
                <nav class="mt-8 flex flex-row items-center justify-between gap-4 bg-white px-6 py-4 rounded-lg shadow-md border border-gray-200">
                    <!-- Previous Button -->
                    {hasPrevPage ? (
                        <a
                            href={`?page=${currentPage - 1}`}
                            class="inline-flex items-center gap-2 px-4 py-2.5 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 hover:shadow-lg transition-all duration-200"
                        >
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                            <span class="hidden sm:inline">Anterior</span>
                        </a>
                    ) : (
                        <button
                            disabled
                            class="inline-flex items-center gap-2 px-4 py-2.5 bg-gray-300 text-gray-500 font-medium rounded-lg cursor-not-allowed"
                        >
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                            <span class="hidden sm:inline">Anterior</span>
                        </button>
                    )}

                    <!-- Page Numbers and Indicator -->
                    <div class="flex items-center gap-3">
                        {news.length > 0 && (
                            <>
                                <!-- Page Numbers (visible on larger screens) -->
                                <div class="hidden md:flex items-center gap-2">
                                    <!-- Primera página si no está visible -->
                                    {showFirstPage && (
                                        <>
                                            <a
                                                href="?page=1"
                                                class="px-3 py-2 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition-colors"
                                            >
                                                1
                                            </a>
                                            {currentPage > 4 && (
                                                <span class="text-gray-400">...</span>
                                            )}
                                        </>
                                    )}

                                    <!-- Páginas cercanas -->
                                    {pagesToShow.map(page => (
                                        page === currentPage ? (
                                            <span class="px-3 py-2 bg-primary text-white rounded-lg font-bold min-w-[2.5rem] text-center">
                                                {page}
                                            </span>
                                        ) : (
                                            <a
                                                href={`?page=${page}`}
                                                class="px-3 py-2 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition-colors"
                                            >
                                                {page}
                                            </a>
                                        )
                                    ))}

                                    <!-- Última página si no está visible -->
                                    {showLastPage && (
                                        <>
                                            {currentPage < totalPages! - 3 && (
                                                <span class="text-gray-400">...</span>
                                            )}
                                            <a
                                                href={`?page=${totalPages}`}
                                                class="px-3 py-2 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition-colors"
                                            >
                                                {totalPages}
                                            </a>
                                        </>
                                    )}

                                    <!-- Indicador de más páginas si no conocemos el total -->
                                    {!totalPages && hasMore && (
                                        <span class="text-gray-400">...</span>
                                    )}
                                </div>

                                
                            </>
                        )}
                    </div>

                    <!-- Next Button -->
                    {hasNextPage ? (
                        <a
                            href={`?page=${currentPage + 1}`}
                            class="inline-flex items-center gap-2 px-4 py-2.5 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 hover:shadow-lg transition-all duration-200"
                        >
                            <span class="hidden sm:inline">Siguiente</span>
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    ) : (
                        <button
                            disabled
                            class="inline-flex items-center gap-2 px-4 py-2.5 bg-gray-300 text-gray-500 font-medium rounded-lg cursor-not-allowed"
                        >
                            <span class="hidden sm:inline">Siguiente</span>
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    )}
                </nav>
            </div>
        )}
    </section>
</NewsLayout>
