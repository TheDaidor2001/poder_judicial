---
import NewsLayout from "../../layouts/NewsLayout.astro";
import { fetchNewsBySlug, formatPublishedDate } from "../../utils/newsAPI";

const { slug } = Astro.params;

// Verificar que el slug existe
if (!slug) {
    return Astro.redirect("/noticias_judiciales");
}

// Obtener la noticia del API
let noticia = null;
let error: string | null = null;

try {
    noticia = await fetchNewsBySlug(slug);

    if (!noticia) {
        return Astro.redirect("/noticias_judiciales");
    }
} catch (e) {
    error =
        e instanceof Error
            ? e.message
            : "Error desconocido al cargar la noticia";
    console.error("Error fetching news:", e);
}

// Si hay error o no hay noticia, redirigir
if (error || !noticia) {
    return Astro.redirect("/noticias_judiciales");
}

// Debug: log completo del JSON de la noticia
console.log("JSON completo de la noticia:", JSON.stringify(noticia, null, 2));
---

<NewsLayout
    title={`${noticia.title} | Poder Judicial de Guinea Ecuatorial`}
    description={noticia.subtitle}
    image={noticia.imageUrl}
    date={noticia.publishedAt}
>
    <section class="xl:col-span-3 w-full overflow-hidden">
        <article class="w-full max-w-full overflow-hidden">
            <!-- Fecha -->
            <p class="text-gray-700 text-sm sm:text-base">
                <time class="capitalize"
                    >{formatPublishedDate(noticia.publishedAt)}</time
                >
            </p>

            <!-- Título -->
            <h1 class="text-xl md:text-2xl lg:text-4xl font-semibold mt-3">
                {noticia.title}
            </h1>

            <!-- Subtítulo -->
            <p class="text-sm sm:text-lg text-gray-700 mt-5">
                {noticia.subtitle}
            </p>

            <!-- Separador -->
            <div data-separator class="w-40 h-2 bg-secondary mt-3"></div>

            <!-- Imagen destacada -->

            <div class="w-full mt-5 rounded">
                <img
                    src={noticia.imageUrl}
                    alt={noticia.title}
                    class="w-full h-auto rounded"
                    onerror="this.style.display='none'"
                />
            </div>

            <!-- Tipo de noticia -->
            {
                noticia.type && (
                    <div class="mt-5">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary">
                            {noticia.type}
                        </span>
                    </div>
                )
            }

            <!-- Contenido de la noticia -->
            {
                noticia.content && (
                    <div
                        id="contenido"
                        class="w-full max-w-full prose prose-md mt-8 overflow-hidden"
                        set:html={noticia.content}
                    />
                )
            }

            <!-- Botón de volver -->
            <div class="mt-12 pt-8 border-t border-gray-200 mb-10">
                <a
                    href="/noticias_judiciales"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 hover:shadow-lg transition-all duration-200"
                >
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Volver a Noticias
                </a>
            </div>
        </article>
    </section>
</NewsLayout>
