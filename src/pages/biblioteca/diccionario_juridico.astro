---
import MainLayout from "../../layouts/MainLayout.astro";
import {
    diccionarioTerminos,
    type DiccionarioTerminos,
} from "../../config/constants/terminos";

// Obtener todas las letras disponibles
const letrasDisponibles: string[] = [
    ...new Set(
        Object.keys(diccionarioTerminos).map((termino: string) =>
            termino.charAt(0).toUpperCase(),
        ),
    ),
].sort();
---

<MainLayout title="Poder Judicial de Guinea Ecuatorial | Diccionario Jur√≠dico">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <header class="text-center mb-12 pb-8 border-b-2 border-gray-200">
            <h1
                class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900 mb-4"
            >
                Diccionario de T√©rminos Jur√≠dicos
            </h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto leading-relaxed">
                Consulta el significado de los t√©rminos jur√≠dicos m√°s utilizados
                en el √°mbito legal de Guinea Ecuatorial
            </p>
        </header>

        <!-- Navegaci√≥n por letras -->
        <nav
            class="flex flex-wrap gap-2 justify-center mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200"
            id="letrasNav"
        >
            {
                letrasDisponibles.map((letra) => (
                    <button
                        class="letra-btn px-4 py-3 bg-white border-2 border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-secondary hover:text-white hover:border-secondary hover:-translate-y-0.5 hover:shadow-lg transition-all duration-200 min-w-[45px] focus:outline-none focus:ring-2 focus:ring-secondary focus:ring-offset-2"
                        data-letra={letra}
                        onclick={`mostrarTerminos('${letra}')`}
                    >
                        {letra}
                    </button>
                ))
            }
        </nav>

        <!-- Buscador -->
        <div class="relative max-w-lg mx-auto mb-12">
            <input
                type="text"
                id="buscador"
                placeholder="Buscar t√©rmino jur√≠dico..."
                class="w-full px-4 py-4 pr-12 border-2 border-gray-300 rounded-xl text-base focus:outline-none focus:border-secondary focus:ring-4 focus:ring-blue-100 transition-all duration-200"
            />
            <button
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-secondary p-2 transition-colors duration-200"
                onclick="buscarTermino()"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </button>
        </div>

        <!-- Contenido de t√©rminos -->
        <main class="min-h-[400px]" id="terminosContainer">
            <div class="text-center py-16 text-gray-500">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">
                    Selecciona una letra para ver los t√©rminos
                </h2>
                <p class="text-lg">
                    Utiliza la navegaci√≥n superior o el buscador para encontrar
                    t√©rminos jur√≠dicos
                </p>
            </div>
        </main>
    </div>
</MainLayout>

<script>
    import {
        diccionarioTerminos,
        type DiccionarioTerminos,
        type TerminoEntry,
    } from "../../config/constants/terminos";

    // Interfaces para tipado
    interface EstadoAplicacion {
        terminosActuales: DiccionarioTerminos;
        letraActiva: string;
    }

    // Variables globales tipadas
    let estado: EstadoAplicacion = {
        terminosActuales: {},
        letraActiva: "",
    };

    // Funci√≥n para obtener elemento del DOM de forma segura
    function obtenerElemento<T extends HTMLElement>(id: string): T {
        const elemento = document.getElementById(id) as T | null;
        if (!elemento) {
            throw new Error(`Elemento con ID '${id}' no encontrado`);
        }
        return elemento;
    }

    // Funci√≥n para obtener elementos del DOM de forma segura
    function obtenerElementos<T extends Element>(
        selector: string,
    ): NodeListOf<T> {
        return document.querySelectorAll<T>(selector);
    }

    // Funci√≥n para actualizar clases de botones
    function actualizarClasesBoton(
        boton: HTMLButtonElement,
        esActivo: boolean,
    ): void {
        if (esActivo) {
            boton.classList.remove(
                "bg-white",
                "text-gray-700",
                "border-gray-300",
            );
            boton.classList.add(
                "bg-secondary",
                "text-white",
                "border-secondary",
            );
        } else {
            boton.classList.remove(
                "bg-secondary",
                "text-white",
                "border-secondary",
            );
            boton.classList.add("bg-white", "text-gray-700", "border-gray-300");
        }
    }

    // Funci√≥n para generar HTML de t√©rminos
    function generarHtmlTerminos(
        terminos: TerminoEntry[],
        titulo: string,
    ): string {
        return `
        <div class="mb-12">
          <h2 class="text-4xl font-bold text-gray-900 mb-6 pb-2 border-b-4 border-secondary inline-block">
            ${titulo}
          </h2>
          <div class="space-y-4">
            ${terminos
                .map(
                    ([termino, definicion]) => `
              <div class="bg-white border border-gray-200 rounded-xl p-6 hover:border-secondary hover:shadow-lg transition-all duration-200">
                <h3 class="text-xl font-semibold text-gray-900 mb-3">${termino}</h3>
                <p class="text-gray-600 leading-relaxed">${definicion}</p>
              </div>
            `,
                )
                .join("")}
          </div>
        </div>
      `;
    }

    // Funci√≥n para mostrar mensaje cuando no hay resultados
    function mostrarMensajeVacio(titulo: string, mensaje: string): void {
        const container = obtenerElemento<HTMLElement>("terminosContainer");
        container.innerHTML = `
        <div class="text-center py-16 text-gray-500">
          <h2 class="text-2xl font-semibold text-gray-700 mb-4">
            ${titulo}
          </h2>
          <p class="text-lg">${mensaje}</p>
        </div>
      `;
    }

    // Funci√≥n para mostrar t√©rminos de una letra
    function mostrarTerminos(letra: string): void {
        try {
            const container = obtenerElemento<HTMLElement>("terminosContainer");
            const buttons = obtenerElementos<HTMLButtonElement>(".letra-btn");

            // Limpiar el input de b√∫squeda cuando se selecciona una letra
            const buscador = obtenerElemento<HTMLInputElement>("buscador");
            buscador.value = "";

            // Actualizar bot√≥n activo
            buttons.forEach((btn) => {
                const esActivo = btn.dataset.letra === letra;
                actualizarClasesBoton(btn, esActivo);
            });

            // Filtrar t√©rminos por letra
            const terminosLetra: TerminoEntry[] = Object.entries(
                diccionarioTerminos,
            )
                .filter(
                    ([termino]) => termino.charAt(0).toUpperCase() === letra,
                )
                .sort(([a], [b]) => a.localeCompare(b));

            if (terminosLetra.length === 0) {
                mostrarMensajeVacio(
                    `No hay t√©rminos disponibles para la letra "${letra}"`,
                    "Selecciona otra letra para ver m√°s t√©rminos",
                );
                return;
            }

            // Generar y mostrar HTML
            container.innerHTML = generarHtmlTerminos(terminosLetra, letra);
            estado.letraActiva = letra;
        } catch (error) {
            console.error("Error al mostrar t√©rminos:", error);
            mostrarMensajeVacio(
                "Error",
                "Ha ocurrido un error al cargar los t√©rminos",
            );
        }
    }

    // Funci√≥n para buscar t√©rminos
    function buscarTermino(): void {
        console.log("üîç Funci√≥n buscarTermino ejecutada");
        try {
            const buscadorInput = obtenerElemento<HTMLInputElement>("buscador");
            const query: string = buscadorInput.value.toLowerCase().trim();
            const container = obtenerElemento<HTMLElement>("terminosContainer");

            console.log("üìù Query de b√∫squeda:", query);
            console.log(
                "üìä Diccionario disponible:",
                Object.keys(diccionarioTerminos).length,
                "t√©rminos",
            );

            // Verificar que el diccionario est√© disponible
            if (
                !diccionarioTerminos ||
                Object.keys(diccionarioTerminos).length === 0
            ) {
                console.error("‚ùå El diccionario est√° vac√≠o o no disponible");
                mostrarMensajeVacio(
                    "Error de datos",
                    "El diccionario de t√©rminos no est√° disponible",
                );
                return;
            }

            // Limpiar botones activos cuando se busca
            const buttons = obtenerElementos<HTMLButtonElement>(".letra-btn");
            buttons.forEach((btn) => actualizarClasesBoton(btn, false));

            if (!query) {
                console.log("‚ö†Ô∏è Query vac√≠a, mostrando mensaje inicial");
                mostrarMensajeVacio(
                    "Selecciona una letra para ver los t√©rminos",
                    "Utiliza la navegaci√≥n superior o el buscador para encontrar t√©rminos jur√≠dicos",
                );
                return;
            }

            // Buscar t√©rminos que coincidan
            const resultados: TerminoEntry[] = Object.entries(
                diccionarioTerminos,
            )
                .filter(
                    ([termino, definicion]) =>
                        termino.toLowerCase().includes(query) ||
                        definicion.toLowerCase().includes(query),
                )
                .sort(([a], [b]) => a.localeCompare(b));

            console.log("üéØ Resultados encontrados:", resultados.length);

            if (resultados.length === 0) {
                console.log("‚ùå No se encontraron resultados para:", query);
                mostrarMensajeVacio(
                    "No se encontraron resultados",
                    `No hay t√©rminos que coincidan con "${query}"`,
                );
                return;
            }

            // Mostrar resultados
            console.log("‚úÖ Mostrando resultados para:", query);
            container.innerHTML = generarHtmlTerminos(
                resultados,
                `Resultados para "${query}" (${resultados.length})`,
            );
        } catch (error) {
            console.error("üí• Error al buscar t√©rminos:", error);
            mostrarMensajeVacio(
                "Error",
                "Ha ocurrido un error durante la b√∫squeda",
            );
        }
    }

    // Event listeners con tipado
    document.addEventListener("DOMContentLoaded", (): void => {
        console.log("üöÄ DOM cargado, inicializando eventos");
        try {
            // Verificar que el diccionario est√© cargado
            console.log("üìö Estado del diccionario:", {
                disponible: !!diccionarioTerminos,
                cantidadTerminos: Object.keys(diccionarioTerminos || {}).length,
            });

            // B√∫squeda en tiempo real
            const buscador = obtenerElemento<HTMLInputElement>("buscador");
            let timeoutId: number;

            console.log("üîß Configurando event listeners del buscador");

            buscador.addEventListener("input", (): void => {
                console.log("‚å®Ô∏è Input detectado, iniciando b√∫squeda en 300ms");
                clearTimeout(timeoutId);
                timeoutId = window.setTimeout(() => {
                    console.log("‚è∞ Timeout completado, ejecutando b√∫squeda");
                    buscarTermino();
                }, 300);
            });

            // Enter en buscador
            buscador.addEventListener("keypress", (e: KeyboardEvent): void => {
                if (e.key === "Enter") {
                    console.log(
                        "‚èé Enter presionado, ejecutando b√∫squeda inmediata",
                    );
                    e.preventDefault();
                    clearTimeout(timeoutId);
                    buscarTermino();
                }
            });

            console.log("‚úÖ Event listeners inicializados correctamente");

            // Verificar que las funciones globales est√©n disponibles
            setTimeout(() => {
                console.log("üåê Verificando funciones globales:", {
                    mostrarTerminos: typeof window.mostrarTerminos,
                    buscarTermino: typeof window.buscarTermino,
                });
            }, 100);
        } catch (error) {
            console.error("üí• Error al inicializar event listeners:", error);
        }
    });

    // Declarar funciones globales para el window object
    declare global {
        interface Window {
            mostrarTerminos: (letra: string) => void;
            buscarTermino: () => void;
        }
    }

    // Hacer funciones globales
    window.mostrarTerminos = mostrarTerminos;
    window.buscarTermino = buscarTermino;
</script>
